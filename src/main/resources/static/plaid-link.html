<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Plaid Link Token Demo</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>

<body>
    <button id="linkButton">Connect Bank Account (Plaid)</button>
    <pre id="output"></pre>

    <script>
        // Step 1: Fetch link_token from your backend
        async function getLinkToken() {
            const res = await fetch('http://localhost:8080/api/plaid/create_link_token');
            const data = await res.json();
            return data.link_token;
        }

        document.getElementById('linkButton').onclick = async function () {
            // Get a fresh link_token from backend
            const linkToken = await getLinkToken();

            const handler = Plaid.create({
                token: linkToken,
                onSuccess: async function (public_token, metadata) {
                    document.getElementById('output').innerText = 'Public Token: ' + public_token;

                    // Step 2: Immediately exchange public_token for access_token via your backend
                    const res = await fetch('http://localhost:8080/api/plaid/exchange_public_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ public_token })
                    });

                    const result = await res.json();
                    document.getElementById('output').innerText =
                        'Public Token: ' + public_token + '\nAccess Token Response:\n' + JSON.stringify(result, null, 2);
                },
                onExit: function (err, metadata) {
                    document.getElementById('output').innerText = 'Plaid Link exited.';
                }
            });

            handler.open();
        };
    </script>
</body>

</html>